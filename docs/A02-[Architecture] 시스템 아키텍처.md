# [Architecture] MAIPatent 시스템 아키텍처

> **n8n + Claude Code 기반 지능형 특허 명세서 작성 자동화 시스템 아키텍처 설계**

---

## 1. 시스템 개요

MAIPatent는 n8n 워크플로우 오케스트레이션과 Claude Code AI 엔진을 결합하여 특허 명세서 자동 생성을 수행하는 시스템입니다.

### 핵심 구성요소

| 구성요소 | 역할 | 기술 |
|----------|------|------|
| **Orchestration Layer** | 워크플로우 관리, 프로세스 조율 | n8n Cloud |
| **AI Processing Layer** | 명세서 생성, 텍스트 처리 | Claude Code (MCP) |
| **Data Layer** | 입출력 데이터 관리 | Google Drive, Sheets |
| **External API Layer** | 선행기술 검색 | KIPRIS API |
| **Output Layer** | 문서 변환 및 출력 | Pandoc |

---

## 2. 시스템 아키텍처 다이어그램

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                            MAIPatent System Architecture                      │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                        INPUT LAYER                                   │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │    │
│  │  │ Google Drive │  │   Webhook    │  │  n8n Form    │              │    │
│  │  │  (발명제안서) │  │   (API)      │  │  (사용자입력) │              │    │
│  │  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘              │    │
│  │         └─────────────────┼─────────────────┘                       │    │
│  └───────────────────────────┼─────────────────────────────────────────┘    │
│                              ▼                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                   N8N ORCHESTRATION LAYER                            │    │
│  │  ┌─────────────────────────────────────────────────────────────┐   │    │
│  │  │                    Workflow Controller                       │   │    │
│  │  │  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐            │   │    │
│  │  │  │  WF01  │→│  WF02  │→│  WF03  │→│  WF04  │            │   │    │
│  │  │  │ Input  │  │ Search │  │Generate│  │ Review │            │   │    │
│  │  │  └────────┘  └────────┘  └────────┘  └────────┘            │   │    │
│  │  └─────────────────────────────────────────────────────────────┘   │    │
│  │                              │                                      │    │
│  │  ┌──────────────────────────┴──────────────────────────┐          │    │
│  │  │              Error Handling & Logging                │          │    │
│  │  └─────────────────────────────────────────────────────┘          │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                              │                                               │
│         ┌────────────────────┼────────────────────┐                         │
│         ▼                    ▼                    ▼                         │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                     │
│  │ KIPRIS API  │    │ Claude Code │    │Human Review │                     │
│  │ (선행기술)   │    │   (MCP)     │    │ (Wait Node) │                     │
│  │             │    │             │    │             │                     │
│  │ - 특허검색   │    │ - 청구항생성 │    │ - 검수승인   │                     │
│  │ - IPC분류   │    │ - 상세설명   │    │ - 피드백    │                     │
│  │ - 출원인조회 │    │ - 도면설명   │    │ - 수정요청   │                     │
│  └─────────────┘    └─────────────┘    └─────────────┘                     │
│         │                    │                    │                         │
│         └────────────────────┼────────────────────┘                         │
│                              ▼                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                       OUTPUT LAYER                                   │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │    │
│  │  │   Markdown   │→│    DOCX      │→│     PDF      │              │    │
│  │  │ (KIPO 규격)  │  │  (Pandoc)    │  │  (최종출력)   │              │    │
│  │  └──────────────┘  └──────────────┘  └──────────────┘              │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 데이터 흐름 (Data Flow)

### 3.1. 전체 데이터 흐름

```
발명 제안서 입력
       │
       ▼
┌──────────────────┐
│ 1. 데이터 검증    │ → 필수 필드 확인, 형식 검증
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 2. 키워드 추출    │ → 발명 제목, 기술분야에서 핵심 키워드 추출
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 3. 선행기술 검색  │ → KIPRIS API 호출, 관련 특허 수집
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 4. 컨텍스트 구성  │ → 발명 제안서 + 선행기술 요약 결합
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 5. 명세서 생성    │ → Claude Code 순차 생성
│   - 청구항       │    (Extended Thinking 활용)
│   - 상세설명     │
│   - 도면설명     │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 6. KIPO 포맷팅   │ → 【】 식별 기호 삽입, 규격 적용
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 7. 인간 검수      │ → Wait Node, 전문가 리뷰
└────────┬─────────┘
         │
    ┌────┴────┐
    ▼         ▼
 승인       수정요청
    │         │
    │    ┌────┘
    │    ▼
    │  [피드백 반영]
    │    │
    │    └──→ (5단계로 복귀)
    │
    ▼
┌──────────────────┐
│ 8. 문서 변환      │ → Pandoc (.md → .docx/.pdf)
└────────┬─────────┘
         │
         ▼
    최종 명세서 출력
```

### 3.2. 데이터 구조

#### 발명 제안서 입력 스키마
```json
{
  "invention": {
    "title": "발명의 명칭",
    "technical_field": "기술분야",
    "background": {
      "problem": "해결하려는 과제",
      "existing_solutions": "기존 해결책의 문제점"
    },
    "solution": {
      "description": "발명의 핵심 구성",
      "advantages": "발명의 효과"
    },
    "drawings": [
      {
        "figure_number": 1,
        "description": "도면 설명"
      }
    ],
    "ipc_codes": ["G06F 3/01"],
    "keywords": ["핵심", "키워드", "목록"]
  },
  "metadata": {
    "applicant": "출원인",
    "inventor": "발명자",
    "submission_date": "2026-01-10"
  }
}
```

#### 생성된 명세서 출력 스키마
```json
{
  "patent_specification": {
    "title": "【발명의 명칭】 ...",
    "technical_field": "【기술분야】 ...",
    "background_art": "【배경기술】 ...",
    "disclosure": {
      "problem_to_solve": "【해결하려는 과제】 ...",
      "solution": "【과제의 해결 수단】 ...",
      "effects": "【발명의 효과】 ..."
    },
    "drawing_description": "【도면의 간단한 설명】 ...",
    "detailed_description": "【발명을 실시하기 위한 구체적인 내용】 ...",
    "claims": "【특허청구범위】 ...",
    "abstract": "【요약서】 ..."
  },
  "metadata": {
    "version": "1.0",
    "generated_at": "2026-01-10T10:00:00Z",
    "generation_time_seconds": 180,
    "word_count": 5000
  }
}
```

---

## 4. n8n 워크플로우 상세 설계

### 4.1. WF01: 발명 제안서 입력

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ Form/Webhook│ →   │  Validate   │ →   │Store to DB  │ →   │Trigger WF02 │
│   Trigger   │     │   Input     │     │(Google Sheet)│     │  (HTTP)    │
└─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘
```

**노드 상세:**
| 노드 | 유형 | 설명 |
|------|------|------|
| Trigger | n8n Form / Webhook | 발명 제안서 입력 수신 |
| Validate | Code (JavaScript) | 필수 필드 검증, 데이터 정제 |
| Store | Google Sheets | 입력 데이터 저장 및 이력 관리 |
| Trigger WF02 | HTTP Request | 다음 워크플로우 호출 |

### 4.2. WF02: 선행기술 검색 (KIPRIS)

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   Trigger   │ →   │  Extract    │ →   │ KIPRIS API  │ →   │   Parse     │
│  (Webhook)  │     │  Keywords   │     │   Request   │     │  Results    │
└─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘
                                                                    │
                    ┌─────────────┐     ┌─────────────┐             │
                    │Trigger WF03 │ ←   │Store Context│ ←───────────┘
                    │             │     │             │
                    └─────────────┘     └─────────────┘
```

**노드 상세:**
| 노드 | 유형 | 설명 |
|------|------|------|
| Extract Keywords | Code | 발명 제목/기술분야에서 검색 키워드 추출 |
| KIPRIS API | HTTP Request | KIPRIS Open API 호출 |
| Parse Results | Code | 검색 결과 파싱, 요약 생성 |
| Store Context | Set | 컨텍스트 데이터 저장 |

### 4.3. WF03: Claude Code 명세서 생성

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   Trigger   │ →   │Load Context │ →   │  Generate   │
│  (Webhook)  │     │ (Get Data)  │     │   Claims    │
└─────────────┘     └─────────────┘     └──────┬──────┘
                                               │
        ┌──────────────────────────────────────┘
        ▼
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  Generate   │ →   │  Generate   │ →   │   Format    │
│ Description │     │Drawing Desc │     │    KIPO     │
└─────────────┘     └─────────────┘     └──────┬──────┘
                                               │
        ┌──────────────────────────────────────┘
        ▼
┌─────────────┐     ┌─────────────┐
│  Export MD  │ →   │Trigger WF04 │
│             │     │             │
└─────────────┘     └─────────────┘
```

**AI 생성 순서 (필수):**
1. **청구항** (Claims) - Extended Thinking 사용
2. **상세한 설명** (Detailed Description) - 청구항 참조
3. **도면 설명** (Drawing Description) - 부호 일관성

### 4.4. WF04: Human-in-the-loop 검수

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   Trigger   │ →   │  Wait for   │ →   │   Review    │
│  (Webhook)  │     │  Approval   │     │   Decision  │
└─────────────┘     └─────────────┘     └──────┬──────┘
                                               │
                                    ┌──────────┴──────────┐
                                    ▼                     ▼
                            ┌─────────────┐       ┌─────────────┐
                            │  Approved   │       │  Rejected   │
                            │             │       │             │
                            └──────┬──────┘       └──────┬──────┘
                                   │                     │
                                   ▼                     ▼
                            ┌─────────────┐       ┌─────────────┐
                            │   Pandoc    │       │  Feedback   │
                            │  Convert    │       │   to WF03   │
                            └──────┬──────┘       └─────────────┘
                                   │
                                   ▼
                            ┌─────────────┐
                            │   Export    │
                            │  Document   │
                            └─────────────┘
```

---

## 5. Claude Code MCP 통합

### 5.1. MCP 서버 구성

현재 `.mcp.json` 설정:
```json
{
  "mcpServers": {
    "n8n-mcp": {
      "command": "cmd.exe",
      "args": ["/c", "npx", "-y", "n8n-mcp"],
      "env": {
        "N8N_API_URL": "https://mai-n8n.app.n8n.cloud",
        "N8N_API_KEY": "[CONFIGURED]"
      }
    }
  }
}
```

### 5.2. Claude Code 호출 패턴

**n8n에서 Claude Code 호출 방식:**

1. **MCP Tools 직접 사용** (권장)
   - n8n MCP 서버를 통해 Claude Code MCP tools 호출
   - 워크플로우 생성/수정/검증 자동화

2. **Execute Command 노드** (대안)
   - Claude Code CLI 직접 실행
   - 로컬 파일 시스템 접근 필요 시

### 5.3. 프롬프트 구조

각 섹션 생성을 위한 프롬프트 템플릿:

```markdown
# prompts/claim-generator.md

## 역할
당신은 한국 특허청(KIPO) 규격에 맞는 특허 청구항을 작성하는 전문가입니다.

## 입력
- 발명 제목: {{invention.title}}
- 기술분야: {{invention.technical_field}}
- 해결과제: {{invention.background.problem}}
- 해결수단: {{invention.solution.description}}
- 선행기술: {{prior_art_summary}}

## 출력 형식
【특허청구범위】
【청구항 1】
(독립항) ...

【청구항 2】
(종속항) 제1항에 있어서, ...

## 작성 규칙
1. 청구항은 명확하고 간결하게 작성
2. 독립항은 발명의 핵심 구성요소를 포함
3. 종속항은 독립항을 인용하며 추가 특징 기술
4. 전제 기초(Antecedent Basis) 준수
5. 과장 표현 금지 ("완벽한", "절대적인" 등)
```

---

## 6. 보안 아키텍처

### 6.1. 데이터 보안

```
┌─────────────────────────────────────────────────────────────┐
│                    Security Architecture                     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐                                           │
│  │  User Input │                                           │
│  └──────┬──────┘                                           │
│         │ HTTPS                                             │
│         ▼                                                   │
│  ┌─────────────────────────────────────────┐              │
│  │           n8n Cloud (Secured)            │              │
│  │  ┌─────────────────────────────────┐   │              │
│  │  │    Credential Manager           │   │              │
│  │  │  - API Keys (encrypted)         │   │              │
│  │  │  - OAuth tokens                 │   │              │
│  │  └─────────────────────────────────┘   │              │
│  └──────────────────┬──────────────────────┘              │
│                     │                                       │
│         ┌───────────┴───────────┐                         │
│         ▼                       ▼                         │
│  ┌─────────────┐         ┌─────────────┐                 │
│  │ Claude API  │         │ KIPRIS API  │                 │
│  │ (ZDR Mode)  │         │ (Read Only) │                 │
│  └─────────────┘         └─────────────┘                 │
│                                                             │
│  보안 정책:                                                 │
│  - Zero Data Retention (ZDR) 적용                          │
│  - API 키 환경변수 관리                                     │
│  - 임시 파일 즉시 삭제                                      │
│  - 미공개 출원 정보 암호화                                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 6.2. 인증 및 권한

| 서비스 | 인증 방식 | 권한 |
|--------|----------|------|
| n8n Cloud | OAuth / API Key | Workflow 실행 |
| Claude API | API Key (env) | Text Generation |
| KIPRIS API | API Key | Read Only |
| Google Drive | OAuth 2.0 | Read/Write |

---

## 7. 확장성 고려사항

### 7.1. 수평 확장

- n8n Cloud는 자동 스케일링 지원
- 워크플로우 분할로 부하 분산
- 비동기 처리로 병목 방지

### 7.2. 향후 확장 계획

| 단계 | 확장 내용 |
|------|----------|
| v1.1 | 다국어 명세서 지원 (PCT) |
| v1.2 | 도면 자동 생성 (Mermaid/PlantUML) |
| v2.0 | 출원서 자동 작성 |
| v2.1 | OA 대응 초안 생성 |

---

## 8. 모니터링 및 로깅

### 8.1. 모니터링 지표

| 지표 | 임계값 | 알림 |
|------|--------|------|
| 워크플로우 실행 시간 | > 10분 | Warning |
| API 호출 실패율 | > 5% | Critical |
| 문서 생성 오류율 | > 1% | Warning |

### 8.2. 로깅 구조

```
[Timestamp] [Level] [Workflow] [Node] Message
2026-01-10 10:00:00 INFO WF03 GenerateClaims Started claim generation
2026-01-10 10:01:30 INFO WF03 GenerateClaims Completed (90s)
2026-01-10 10:01:31 ERROR WF03 FormatKIPO Missing required field: abstract
```

---

*문서 버전: 1.0.0*
*작성일: 2026-01-10*
